DROP TABLE IF EXISTS STATS;

CREATE TABLE STATS (
    STAT_ID INT(11) AUTO_INCREMENT PRIMARY KEY,
    STAT_DATE DATETIME NOT NULL,
    STAT VARCHAR(20) NOT NULL,
    VALUE INT(11) NOT NULL);
    
DROP VIEW IF EXISTS bestsellers_count;

CREATE VIEW BESTSELLERS_COUNT AS
    SELECT COUNT(0) AS COUNT
    FROM BOOKS
    WHERE bestseller > 0
    GROUP BY BESTSELLER;

DELIMITER $$

USE KODILLA_COURSE;
CREATE EVENT UPDATE_BESTSELLERS
   ON SCHEDULE EVERY 1 MINUTE
   DO 
	BEGIN 
	    CALL UpdateBestsellers();
	    INSERT INTO STATS(STAT_DATE, STAT,VALUE) SELECT curdate(), 'bestsellers', COUNT FROM bestsellers_count;
      COMMIT;
	END
    
DELIMITER;
